import React, { useState, useEffect } from 'react';
import { Calendar, CheckCircle, Circle, Bell, Award } from 'lucide-react';

const TodoTracker = () => {
  const taskData = [
    {
      day: 1, 
      title: "定位与准备",
      items: [
        { id: "t1_1", text: "确定自动化服务主题" },
        { id: "t1_2", text: "注册 Finnhub + Supabase + n8n" }
      ],
      acceptance: "有明确服务方向 + n8n能登录 + API key可用",
      test: "用Finnhub key测试一次API调用",
      reward: "喝杯咖啡庆祝"
    },
    {
      day: 2, 
      title: "Demo 1: API → Google Sheet",
      items: [
        { id: "t2_1", text: "n8n拉取股票数据" },
        { id: "t2_2", text: "数据写入Google Sheet" }
      ],
      acceptance: "Sheet有新数据,包含ticker/price/time",
      test: "换ticker确认数据变化",
      reward: "30分钟放松+发朋友圈"
    },
    {
      day: 3, 
      title: "Demo 2: 定时推送",
      items: [
        { id: "t3_1", text: "添加Scheduler节点" },
        { id: "t3_2", text: "邮件推送配置" }
      ],
      acceptance: "每次执行都收到邮件",
      test: "改成1分钟触发测试",
      reward: "看一集喜欢的剧"
    },
    {
      day: 4, 
      title: "Demo 3: 生成PDF报告",
      items: [
        { id: "t4_1", text: "加入PDF生成节点" },
        { id: "t4_2", text: "自动上传或发送" }
      ],
      acceptance: "PDF包含标题/股票名/价格/日期",
      test: "改ticker再跑一次看PDF更新",
      reward: "买小礼物奖励自己"
    },
    {
      day: 5, 
      title: "产品化 & 文案",
      items: [
        { id: "t5_1", text: "组合完整Demo案例" },
        { id: "t5_2", text: "截图workflow和结果" },
        { id: "t5_3", text: "准备Fiverr文案" }
      ],
      acceptance: "Demo文档+Gig文案完整",
      test: "发给朋友测试能否使用",
      reward: "吃顿喜欢的餐"
    },
    {
      day: 6, 
      title: "上架Fiverr",
      items: [
        { id: "t6_1", text: "注册Fiverr卖家" },
        { id: "t6_2", text: "上架Gig三档定价" },
        { id: "t6_3", text: "上传截图描述" }
      ],
      acceptance: "Gig可见,链接可分享",
      test: "用其他账号查看Gig显示",
      reward: "发推/朋友圈分享上线"
    },
    {
      day: 7, 
      title: "推广与优化",
      items: [
        { id: "t7_1", text: "社交媒体发布Demo" },
        { id: "t7_2", text: "2-3个社区分享" },
        { id: "t7_3", text: "观察反馈优化" }
      ],
      acceptance: "3-5次点击或咨询",
      test: "查看Fiverr浏览量和反馈",
      reward: "大礼物奖励自己"
    }
  ];

  const [completed, setCompleted] = useState({});
  const [notifyTime, setNotifyTime] = useState("09:00");

  useEffect(() => {
    const saved = localStorage.getItem('taskProgress');
    if (saved) {
      try {
        setCompleted(JSON.parse(saved));
      } catch (e) {
        setCompleted({});
      }
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('taskProgress', JSON.stringify(completed));
  }, [completed]);

  const toggleTask = (taskId) => {
    setCompleted(prev => ({
      ...prev,
      [taskId]: !prev[taskId]
    }));
  };

  const getTotalProgress = () => {
    const total = taskData.reduce((sum, day) => sum + day.items.length, 0);
    const done = Object.values(completed).filter(Boolean).length;
    return { total, done, percent: Math.round((done / total) * 100) };
  };

  const getDayProgress = (day) => {
    const total = day.items.length;
    const done = day.items.filter(item => completed[item.id]).length;
    return Math.round((done / total) * 100);
  };

  const enableNotifications = () => {
    if (!("Notification" in window)) {
      alert("你的浏览器不支持通知功能");
      return;
    }

    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        localStorage.setItem('notifyTime', notifyTime);
        alert(`✅ 通知已开启! 每天${notifyTime}会提醒你`);
      } else {
        alert("请允许通知权限才能使用提醒功能");
      }
    });
  };

  const progress = getTotalProgress();

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
      <div className="max-w-4xl mx-auto">
        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-3xl font-bold text-gray-800 mb-2">
                🚀 7天AI接单启动计划
              </h1>
              <p className="text-gray-600">
                目标: Fiverr店铺上线+1个自动化服务
              </p>
            </div>
            <Calendar className="w-12 h-12 text-blue-500" />
          </div>

          <div className="flex gap-4 items-center bg-blue-50 p-4 rounded-xl flex-wrap">
            <Bell className="w-6 h-6 text-blue-600" />
            <div className="flex-1">
              <label className="text-sm text-gray-700 mr-2">每日提醒时间:</label>
              <input 
                type="time" 
                value={notifyTime}
                onChange={(e) => setNotifyTime(e.target.value)}
                className="border rounded px-3 py-1"
              />
            </div>
            <button 
              onClick={enableNotifications}
              className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            >
              开启提醒
            </button>
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div className="flex justify-between text-sm text-gray-600 mb-2">
            <span>总体进度</span>
            <span>{progress.done} / {progress.total} 完成</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-3">
            <div 
              className="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all"
              style={{width: `${progress.percent}%`}}
            />
          </div>
        </div>

        {taskData.map((day) => {
          const dayProgress = getDayProgress(day);
          
          return (
            <div 
              key={day.day}
              className="bg-white rounded-2xl shadow-lg p-6 mb-4"
            >
              <div className="flex justify-between items-start mb-4">
                <div>
                  <div className="flex items-center gap-2 mb-1">
                    <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                      Day {day.day}
                    </span>
                  </div>
                  <h2 className="text-xl font-bold text-gray-800">{day.title}</h2>
                </div>
                <div className="text-right">
                  <div className="text-2xl font-bold text-blue-600">{dayProgress}%</div>
                  <div className="text-xs text-gray-500">完成度</div>
                </div>
              </div>

              <div className="space-y-3 mb-4">
                {day.items.map((item) => (
                  <div 
                    key={item.id}
                    onClick={() => toggleTask(item.id)}
                    className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition-all"
                  >
                    {completed[item.id] ? (
                      <CheckCircle className="w-6 h-6 text-green-500 flex-shrink-0" />
                    ) : (
                      <Circle className="w-6 h-6 text-gray-300 flex-shrink-0" />
                    )}
                    <span className={`flex-1 ${completed[item.id] ? 'line-through text-gray-400' : 'text-gray-700'}`}>
                      {item.text}
                    </span>
                  </div>
                ))}
              </div>

              <div className="grid md:grid-cols-3 gap-3 text-sm">
                <div className="bg-green-50 p-3 rounded-lg">
                  <div className="font-semibold text-green-800 mb-1">🎯 验收标准</div>
                  <div className="text-green-700">{day.acceptance}</div>
                </div>
                <div className="bg-purple-50 p-3 rounded-lg">
                  <div className="font-semibold text-purple-800 mb-1">🧪 测试方法</div>
                  <div className="text-purple-700">{day.test}</div>
                </div>
                <div className="bg-yellow-50 p-3 rounded-lg">
                  <div className="font-semibold text-yellow-800 mb-1 flex items-center gap-1">
                    <Award className="w-4 h-4" /> 完成奖励
                  </div>
                  <div className="text-yellow-700">{day.reward}</div>
                </div>
              </div>
            </div>
          );
        })}

        <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-2xl p-6 text-center">
          <h3 className="text-xl font-bold mb-2">💡 使用说明</h3>
          <ul className="text-sm space-y-1 text-left max-w-2xl mx-auto">
            <li>✅ 点击任务圆圈可标记完成（自动保存）</li>
            <li>🔔 开启提醒后每天定时收到通知</li>
            <li>📱 可保存此页面到手机主屏幕</li>
            <li>🎯 进度自动保存在浏览器中</li>
          </ul>
        </div>
      </div>
    </div>
  );
};

export default TodoTracker;
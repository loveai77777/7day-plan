import React, { useState, useEffect } from 'react';
import { Calendar, CheckCircle, Circle, Bell, Award } from 'lucide-react';

const TodoTracker = () => {
  const taskData = [
    {
      day: 1, 
      title: "å®šä½ä¸å‡†å¤‡",
      items: [
        { id: "t1_1", text: "ç¡®å®šè‡ªåŠ¨åŒ–æœåŠ¡ä¸»é¢˜" },
        { id: "t1_2", text: "æ³¨å†Œ Finnhub + Supabase + n8n" }
      ],
      acceptance: "æœ‰æ˜ç¡®æœåŠ¡æ–¹å‘ + n8nèƒ½ç™»å½• + API keyå¯ç”¨",
      test: "ç”¨Finnhub keyæµ‹è¯•ä¸€æ¬¡APIè°ƒç”¨",
      reward: "å–æ¯å’–å•¡åº†ç¥"
    },
    {
      day: 2, 
      title: "Demo 1: API â†’ Google Sheet",
      items: [
        { id: "t2_1", text: "n8næ‹‰å–è‚¡ç¥¨æ•°æ®" },
        { id: "t2_2", text: "æ•°æ®å†™å…¥Google Sheet" }
      ],
      acceptance: "Sheetæœ‰æ–°æ•°æ®,åŒ…å«ticker/price/time",
      test: "æ¢tickerç¡®è®¤æ•°æ®å˜åŒ–",
      reward: "30åˆ†é’Ÿæ”¾æ¾+å‘æœ‹å‹åœˆ"
    },
    {
      day: 3, 
      title: "Demo 2: å®šæ—¶æ¨é€",
      items: [
        { id: "t3_1", text: "æ·»åŠ SchedulerèŠ‚ç‚¹" },
        { id: "t3_2", text: "é‚®ä»¶æ¨é€é…ç½®" }
      ],
      acceptance: "æ¯æ¬¡æ‰§è¡Œéƒ½æ”¶åˆ°é‚®ä»¶",
      test: "æ”¹æˆ1åˆ†é’Ÿè§¦å‘æµ‹è¯•",
      reward: "çœ‹ä¸€é›†å–œæ¬¢çš„å‰§"
    },
    {
      day: 4, 
      title: "Demo 3: ç”ŸæˆPDFæŠ¥å‘Š",
      items: [
        { id: "t4_1", text: "åŠ å…¥PDFç”ŸæˆèŠ‚ç‚¹" },
        { id: "t4_2", text: "è‡ªåŠ¨ä¸Šä¼ æˆ–å‘é€" }
      ],
      acceptance: "PDFåŒ…å«æ ‡é¢˜/è‚¡ç¥¨å/ä»·æ ¼/æ—¥æœŸ",
      test: "æ”¹tickerå†è·‘ä¸€æ¬¡çœ‹PDFæ›´æ–°",
      reward: "ä¹°å°ç¤¼ç‰©å¥–åŠ±è‡ªå·±"
    },
    {
      day: 5, 
      title: "äº§å“åŒ– & æ–‡æ¡ˆ",
      items: [
        { id: "t5_1", text: "ç»„åˆå®Œæ•´Demoæ¡ˆä¾‹" },
        { id: "t5_2", text: "æˆªå›¾workflowå’Œç»“æœ" },
        { id: "t5_3", text: "å‡†å¤‡Fiverræ–‡æ¡ˆ" }
      ],
      acceptance: "Demoæ–‡æ¡£+Gigæ–‡æ¡ˆå®Œæ•´",
      test: "å‘ç»™æœ‹å‹æµ‹è¯•èƒ½å¦ä½¿ç”¨",
      reward: "åƒé¡¿å–œæ¬¢çš„é¤"
    },
    {
      day: 6, 
      title: "ä¸Šæ¶Fiverr",
      items: [
        { id: "t6_1", text: "æ³¨å†ŒFiverrå–å®¶" },
        { id: "t6_2", text: "ä¸Šæ¶Gigä¸‰æ¡£å®šä»·" },
        { id: "t6_3", text: "ä¸Šä¼ æˆªå›¾æè¿°" }
      ],
      acceptance: "Gigå¯è§,é“¾æ¥å¯åˆ†äº«",
      test: "ç”¨å…¶ä»–è´¦å·æŸ¥çœ‹Gigæ˜¾ç¤º",
      reward: "å‘æ¨/æœ‹å‹åœˆåˆ†äº«ä¸Šçº¿"
    },
    {
      day: 7, 
      title: "æ¨å¹¿ä¸ä¼˜åŒ–",
      items: [
        { id: "t7_1", text: "ç¤¾äº¤åª’ä½“å‘å¸ƒDemo" },
        { id: "t7_2", text: "2-3ä¸ªç¤¾åŒºåˆ†äº«" },
        { id: "t7_3", text: "è§‚å¯Ÿåé¦ˆä¼˜åŒ–" }
      ],
      acceptance: "3-5æ¬¡ç‚¹å‡»æˆ–å’¨è¯¢",
      test: "æŸ¥çœ‹Fiverræµè§ˆé‡å’Œåé¦ˆ",
      reward: "å¤§ç¤¼ç‰©å¥–åŠ±è‡ªå·±"
    }
  ];

  const [completed, setCompleted] = useState({});
  const [notifyTime, setNotifyTime] = useState("09:00");

  useEffect(() => {
    const saved = localStorage.getItem('taskProgress');
    if (saved) {
      try {
        setCompleted(JSON.parse(saved));
      } catch (e) {
        setCompleted({});
      }
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('taskProgress', JSON.stringify(completed));
  }, [completed]);

  const toggleTask = (taskId) => {
    setCompleted(prev => ({
      ...prev,
      [taskId]: !prev[taskId]
    }));
  };

  const getTotalProgress = () => {
    const total = taskData.reduce((sum, day) => sum + day.items.length, 0);
    const done = Object.values(completed).filter(Boolean).length;
    return { total, done, percent: Math.round((done / total) * 100) };
  };

  const getDayProgress = (day) => {
    const total = day.items.length;
    const done = day.items.filter(item => completed[item.id]).length;
    return Math.round((done / total) * 100);
  };

  const enableNotifications = () => {
    if (!("Notification" in window)) {
      alert("ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½");
      return;
    }

    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        localStorage.setItem('notifyTime', notifyTime);
        alert(`âœ… é€šçŸ¥å·²å¼€å¯! æ¯å¤©${notifyTime}ä¼šæé†’ä½ `);
      } else {
        alert("è¯·å…è®¸é€šçŸ¥æƒé™æ‰èƒ½ä½¿ç”¨æé†’åŠŸèƒ½");
      }
    });
  };

  const progress = getTotalProgress();

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
      <div className="max-w-4xl mx-auto">
        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-3xl font-bold text-gray-800 mb-2">
                ğŸš€ 7å¤©AIæ¥å•å¯åŠ¨è®¡åˆ’
              </h1>
              <p className="text-gray-600">
                ç›®æ ‡: Fiverråº—é“ºä¸Šçº¿+1ä¸ªè‡ªåŠ¨åŒ–æœåŠ¡
              </p>
            </div>
            <Calendar className="w-12 h-12 text-blue-500" />
          </div>

          <div className="flex gap-4 items-center bg-blue-50 p-4 rounded-xl flex-wrap">
            <Bell className="w-6 h-6 text-blue-600" />
            <div className="flex-1">
              <label className="text-sm text-gray-700 mr-2">æ¯æ—¥æé†’æ—¶é—´:</label>
              <input 
                type="time" 
                value={notifyTime}
                onChange={(e) => setNotifyTime(e.target.value)}
                className="border rounded px-3 py-1"
              />
            </div>
            <button 
              onClick={enableNotifications}
              className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            >
              å¼€å¯æé†’
            </button>
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div className="flex justify-between text-sm text-gray-600 mb-2">
            <span>æ€»ä½“è¿›åº¦</span>
            <span>{progress.done} / {progress.total} å®Œæˆ</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-3">
            <div 
              className="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all"
              style={{width: `${progress.percent}%`}}
            />
          </div>
        </div>

        {taskData.map((day) => {
          const dayProgress = getDayProgress(day);
          
          return (
            <div 
              key={day.day}
              className="bg-white rounded-2xl shadow-lg p-6 mb-4"
            >
              <div className="flex justify-between items-start mb-4">
                <div>
                  <div className="flex items-center gap-2 mb-1">
                    <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                      Day {day.day}
                    </span>
                  </div>
                  <h2 className="text-xl font-bold text-gray-800">{day.title}</h2>
                </div>
                <div className="text-right">
                  <div className="text-2xl font-bold text-blue-600">{dayProgress}%</div>
                  <div className="text-xs text-gray-500">å®Œæˆåº¦</div>
                </div>
              </div>

              <div className="space-y-3 mb-4">
                {day.items.map((item) => (
                  <div 
                    key={item.id}
                    onClick={() => toggleTask(item.id)}
                    className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition-all"
                  >
                    {completed[item.id] ? (
                      <CheckCircle className="w-6 h-6 text-green-500 flex-shrink-0" />
                    ) : (
                      <Circle className="w-6 h-6 text-gray-300 flex-shrink-0" />
                    )}
                    <span className={`flex-1 ${completed[item.id] ? 'line-through text-gray-400' : 'text-gray-700'}`}>
                      {item.text}
                    </span>
                  </div>
                ))}
              </div>

              <div className="grid md:grid-cols-3 gap-3 text-sm">
                <div className="bg-green-50 p-3 rounded-lg">
                  <div className="font-semibold text-green-800 mb-1">ğŸ¯ éªŒæ”¶æ ‡å‡†</div>
                  <div className="text-green-700">{day.acceptance}</div>
                </div>
                <div className="bg-purple-50 p-3 rounded-lg">
                  <div className="font-semibold text-purple-800 mb-1">ğŸ§ª æµ‹è¯•æ–¹æ³•</div>
                  <div className="text-purple-700">{day.test}</div>
                </div>
                <div className="bg-yellow-50 p-3 rounded-lg">
                  <div className="font-semibold text-yellow-800 mb-1 flex items-center gap-1">
                    <Award className="w-4 h-4" /> å®Œæˆå¥–åŠ±
                  </div>
                  <div className="text-yellow-700">{day.reward}</div>
                </div>
              </div>
            </div>
          );
        })}

        <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-2xl p-6 text-center">
          <h3 className="text-xl font-bold mb-2">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
          <ul className="text-sm space-y-1 text-left max-w-2xl mx-auto">
            <li>âœ… ç‚¹å‡»ä»»åŠ¡åœ†åœˆå¯æ ‡è®°å®Œæˆï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰</li>
            <li>ğŸ”” å¼€å¯æé†’åæ¯å¤©å®šæ—¶æ”¶åˆ°é€šçŸ¥</li>
            <li>ğŸ“± å¯ä¿å­˜æ­¤é¡µé¢åˆ°æ‰‹æœºä¸»å±å¹•</li>
            <li>ğŸ¯ è¿›åº¦è‡ªåŠ¨ä¿å­˜åœ¨æµè§ˆå™¨ä¸­</li>
          </ul>
        </div>
      </div>
    </div>
  );
};

export default TodoTracker;